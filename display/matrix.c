#include "matrix.h"
#include "pico/stdlib.h"
#include "hardware/pio.h"
#include "hardware/clocks.h"
#include "pio_matrix.pio.h"
#include <stdio.h>

// Pin used for communication with the LED matrix
#define OUTPUT_PIN 7

// Animations and number configurations
AnimationFrames ANIMATIONS[10];
LedMatrix *NUMBERS[10];

// Declaration of animations for numbers 0-9
LedMatrix NUMBERS_0 = {
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

LedMatrix NUMBERS_1 = {
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

LedMatrix NUMBERS_2 = {
        {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}, 
        {{0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
        {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
        {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}, 
        {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    };

LedMatrix NUMBERS_3 = {
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

LedMatrix NUMBERS_4 = {
    {{0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

LedMatrix NUMBERS_5 = {
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

LedMatrix NUMBERS_6 = {
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

LedMatrix NUMBERS_7 = {
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

LedMatrix NUMBERS_8 = {
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

LedMatrix NUMBERS_9 = {
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}, 
    {{0.0, 0.0, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.1, 0.1, 0.0}, {0.0, 0.0, 0.0}}
};

void configure_numbers() {
    NUMBERS[0] = &NUMBERS_0;
    NUMBERS[1] = &NUMBERS_1;
    NUMBERS[2] = &NUMBERS_2;
    NUMBERS[3] = &NUMBERS_3;
    NUMBERS[4] = &NUMBERS_4;
    NUMBERS[5] = &NUMBERS_5;
    NUMBERS[6] = &NUMBERS_6;
    NUMBERS[7] = &NUMBERS_7;
    NUMBERS[8] = &NUMBERS_8;
    NUMBERS[9] = &NUMBERS_9;
}

// Generates a binary value representing the RGB color
uint32_t generate_binary_color(double red, double green, double blue) {
    unsigned char RED, GREEN, BLUE;
    RED = red * 255.0;
    GREEN = green * 255.0;
    BLUE = blue * 255.0;
    return (GREEN << 24) | (RED << 16) | (BLUE << 8);
}

// Configures the PIO for controlling the LED matrix
uint configure_matrix(PIO pio) {
    bool success;
    success = set_sys_clock_khz(128000, false); // Set system clock to 128 MHz
    stdio_init_all(); // Initialize standard I/O
    uint offset = pio_add_program(pio, &pio_matrix_program);
    uint sm = pio_claim_unused_sm(pio, true);
    pio_matrix_program_init(pio, sm, offset, OUTPUT_PIN);
    return sm;
}

// Displays a pattern on the LED matrix
void display_pattern(LedMatrix pattern, PIO pio, uint sm) {
    for (int row = 4; row >= 0; --row) {
        if (row % 2) {
            for (int col = 0; col < 5; ++col) {
                uint32_t color_binary = generate_binary_color(
                    pattern[row][col].red,
                    pattern[row][col].green,
                    pattern[row][col].blue
                );
                pio_sm_put_blocking(pio, sm, color_binary);
            }
        } else {
            for (int col = 4; col >= 0; --col) {
                uint32_t color_binary = generate_binary_color(
                    pattern[row][col].red,
                    pattern[row][col].green,
                    pattern[row][col].blue
                );
                pio_sm_put_blocking(pio, sm, color_binary);
            }
        }
    }
}

// Displays a number on the LED matrix
void display_number(uint number, PIO pio, uint sm) {
    display_pattern(*NUMBERS[number], pio, sm);
}

// Clears the LED matrix
void clear_matrix(PIO pio, uint sm) {
    LedMatrix reset = {
        {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}},
        {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}},
        {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}},
        {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}},
        {{0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}, {0.0, 0.0, 0.0}}
    };
    display_pattern(reset, pio, sm);
}

// Converts RGB values to a normalized color structure
RGBColor get_color_from_rgb(int red, int green, int blue) {
    RGBColor custom_color = {red / 255.0, green / 255.0, blue / 255.0};
    return custom_color;
}